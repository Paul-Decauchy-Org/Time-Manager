name: Time Manager CI/CD Pipeline

on:
  push:
  pull_request:
    branches: ["main"]

jobs:
  # ============================================
  # Block 1: Code Quality (lint back, lint front)
  # ============================================
  quality-check:
    runs-on: ubuntu-latest
    name: Code Quality
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      # Backend lint (active)
      - name: Setup Go (for lint)
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache: true
          cache-dependency-path: back/go.sum

      - name: Check gofmt & go vet
        run: |
          cd back
          test -z "$(gofmt -l .)" || (echo "gofmt found issues" && exit 1)
          go vet ./...

      # Frontend lint (commented for now)
      # - name: Setup Node.js (for frontend lint)
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: "20"
      #     cache: "npm"
      #     cache-dependency-path: front/package-lock.json
      #
      # - name: Lint frontend
      #   run: |
      #     cd front
      #     npm ci
      #     npm run lint

  # ============================================
  # Block 2: Setup Back & Front
  # ============================================
  setup:
    runs-on: ubuntu-latest
    name: Setup Back & Front
    needs: [quality-check]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Go (backend)
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache: true
          cache-dependency-path: back/go.sum

      - name: Install backend deps
        run: |
          cd back
          go mod download

      - name: Setup Node.js (frontend)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: front/package-lock.json

      - name: Install frontend deps
        run: |
          cd front
          npm ci

  # ============================================
  # Block 3: Generate GraphQL artifacts (gqlgen back, codegen front)
  # ============================================
  generate-graphql:
    runs-on: ubuntu-latest
    name: "Generation GraphQL Artifacts"
    needs: [setup]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache: true
          cache-dependency-path: back/go.sum

      - name: Generate backend GraphQL
        working-directory: back
        run: |
          # run gqlgen via go run to avoid requiring a global binary
          go run github.com/99designs/gqlgen@v0.17.81 generate

      - name: Setup Node.js (for codegen)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install frontend deps (needed for codegen)
        working-directory: front
        run: npm ci

      - name: Generate frontend GraphQL
        working-directory: front
        run: npm run codegen

      - name: Upload generated artifacts (optional)
        uses: actions/upload-artifact@v4
        with:
          name: generated-graphql
          path: |
            back/gqlgen.yml
            front/generated
          retention-days: 1

  # ============================================
  # Block 3.5: Frontend Build (install, codegen, build)
  # ============================================
  frontend-build:
    runs-on: ubuntu-latest
    name: Frontend Build
    needs: [generate-graphql]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: front/package-lock.json

      - name: Install frontend dependencies
        working-directory: front
        run: |
          npm ci

      - name: Generate frontend GraphQL types (safety)
        working-directory: front
        run: npm run codegen

      - name: Build Next.js frontend
        working-directory: front
        run: npm run build

      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: front/.next/
          retention-days: 1

  # ============================================
  # Block 4: Tests (backend & frontend) - commented for now
  # ============================================
  tests:
    runs-on: ubuntu-latest
    name: Tests (backend & frontend)
    needs: [generate-graphql]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      # Backend tests (commented for now)
      - name: Run backend tests
        working-directory: back
        run: |
          cp .env.example .env || true
          go test ./... -v

      # Frontend tests (commented for now)
      # - name: Run frontend tests
      #   working-directory: front
      #   run: |
      #     npm test -- --watchAll=false

  # ============================================
  # Block 5: Docker build
  # ============================================
  docker-build:
    runs-on: ubuntu-latest
    name: Docker Build
    needs: [frontend-build, tests]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Prepare backend env
        run: |
          cd back
          cp .env.example .env || true

      - name: Build docker images
        run: docker compose build --no-cache

      - name: Upload docker metadata (optional)
        uses: actions/upload-artifact@v4
        with:
          name: docker-images-meta
          path: |
            # optionally list files you want to save
          retention-days: 1

  # ============================================
  # Block 6: Docker push (only on main)
  # ============================================
  # docker-push:
  #   runs-on: ubuntu-latest
  #   name: Docker Push
  #   needs: [docker-build]
  #   if: github.ref == 'refs/heads/main'
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v5

  #     - name: Login to registry
  #       uses: docker/login-action@v3
  #       with:
  #         registry: ghcr.io
  #         username: ${{ github.actor }}
  #         password: ${{ secrets.GITHUB_TOKEN }}

  #     - name: Push docker images
  #       run: docker compose push

  # ============================================
  # Optional: SonarQube scan using sonar-scanner CLI in Docker
  # requires secrets: SONAR_HOST_URL, SONAR_TOKEN, SONAR_PROJECT_KEY
  # ============================================
  sonarqube-scan:
    runs-on: ubuntu-latest
    name: SonarQube Scan
    needs: [tests]
    env:
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Download backend coverage (if uploaded)
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: back
        continue-on-error: true

      - name: Download frontend coverage (if uploaded)
        uses: actions/download-artifact@v4
        with:
          name: front-coverage
          path: front/coverage
        continue-on-error: true

      - name: Run SonarScanner for backend
        run: |
          set -euo pipefail
          echo "Running SonarScanner for backend..."
          docker run --rm \
            -e SONAR_HOST_URL="${SONAR_HOST_URL}" \
            -e SONAR_TOKEN="${SONAR_TOKEN}" \
            -v "${{ github.workspace }}":/usr/src \
            sonarsource/sonar-scanner-cli \
            -Dsonar.projectKey="${{ secrets.SONAR_PROJECT_KEY_BACK }}" \
            -Dsonar.projectBaseDir=/usr/src/back \
            -Dsonar.sources=. \
            -Dsonar.host.url="${SONAR_HOST_URL}" \
            -Dsonar.login="${SONAR_TOKEN}" \
            -Dsonar.go.coverage.reportPaths=/usr/src/back/coverage.out || true

      - name: Run SonarScanner for frontend
        run: |
          set -euo pipefail
          echo "Running SonarScanner for frontend..."
          docker run --rm \
            -e SONAR_HOST_URL="${SONAR_HOST_URL}" \
            -e SONAR_TOKEN="${SONAR_TOKEN}" \
            -v "${{ github.workspace }}":/usr/src \
            sonarsource/sonar-scanner-cli \
            -Dsonar.projectKey="${{ secrets.SONAR_PROJECT_KEY_FRONT }}" \
            -Dsonar.projectBaseDir=/usr/src/front \
            -Dsonar.sources=./ \
            -Dsonar.host.url="${SONAR_HOST_URL}" \
            -Dsonar.login="${SONAR_TOKEN}" \
            -Dsonar.javascript.lcov.reportPaths=/usr/src/front/coverage/lcov.info || true

      - name: Notify Sonar scan finished
        run: echo "Sonar scans finished for backend and frontend. Check SonarQube dashboard."
